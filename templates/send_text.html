<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8">
        <!-- Latest compiled and minified CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <title>Text Sending</title>
        <!--<script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
		    <link rel="stylesheet" href="../static/styles/index.css">
        <style>
          button {
              background: linear-gradient(to bottom, #00c6ff, #0072ff);
              border: none;
              color: white;
              padding: 10px 20px;
              text-align: center;
              text-decoration: none;
              display: inline-block;
              font-size: 16px;
              margin: 4px 2px;
              cursor: pointer;
              border-radius: 8px;
          }
          label {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 16px;
            font-weight: bold;
            color: #00BFFF;
          }
          textarea{
              margin: 4px 2px;
              border:2px solid #00BFFF;
              border-radius: 3px;
          }
          canvas {
              border:3px solid #00BFFF;
              border-radius: 5px;
              background-color:#FFFFFF;   /*#f1f1f1;*/
              position: relative;
              margin-top: 0.2%;
              /*left: 10%;*/
              width: 720px;
              height: 420px;
          }
          .container {
              display: flex;
              margin-left: 5%;
          }
          .div_buttons{
              display: flex;
              margin-left: 10%;
          }
          .round-button{
              width: 5px;
              height: 5px;
              border-radius: 50%;
              background-color: #008CBA;
              border: none;
              outline: none;
              cursor: pointer;
              /*box-shadow: 0 2px 6px rgba(0,0,0,0.3);*/
          }
        </style>
    </head>
    <body>
        <div class="container">
            <!--<label id="receive-label">Receiving</label>-->
            <textarea id = "receive-text" rows="4" cols="50"></textarea>
        </div>
        <div class = "container">
            <label id="send-label">Sending</label>
        </div>
        <div class="container">
            <textarea id = "send-text" rows="2" cols="80"></textarea>
            <button id = "send-button">send text</button>
            <button id = "chat-history">chat history</button>
            <!--TEST-->
            <button id = "dft_join" style = "display:None;">click to join default room</button>    
        </div>
        <div class="div_buttons">
          <button class="round-button"></button>
          <label id = "message">off line</label>
        </div>
        <script>            
            var server_addr = "http://localhost:5000";
            var socket = null;
            var heartbeatTimer = null;
            var label_message = document.getElementById('message');
            const state = {
              connected: false
            };
            function label_msg(message){
              var label_message = document.getElementById('message');
              label_message.innerHTML  = message;
            }
            function send_heart(){
                // 设置心跳间隔时间
                let heartbeatInterval = 2000; // 2秒
                // 发送心跳请求
                heartbeatTimer = setInterval(() => {
                  socket.emit('heart', { msg: 'heart',
                      username: "yao tang",
                      room: roomId
                    })}
                    , heartbeatInterval);
            }

            //apply for join room
            function join(){
                socket = io.connect(server_addr);
                socket.on('connect_error', function(error) {
                  label_msg("connect error!");
                  console.error('Failed to connect:', error);
                  socket.close();
                });
                socket.on('connect-success', function(data) {
                    label_msg("connect sucess!");
                    state.connected = true;
                    socket.emit('join', 
                    { msg: 'I want to join the room',
                      username: "yao tang",
                      room: roomId
                    });
                    socket.on('join-success',function(data){
                      label_msg("join success!")
                      socket.on('message',onReceiveText);
                      //send_heart()
                    });
                })
            }
            
            function sendText(){
                if(state.connected == false){
                    label_message.setText("please make long connect to server!")
                    return;
                }
                var textarea = document.getElementById('send-text');
                var inputValue = textarea.value;
      
                //create the json to be sent as socketio only
                //receive json message
                var message = {
                  msg: 'text message',
                  username: "yao tang",
                  room: roomId,
                  text: inputValue
                };
                socket.emit('message', message);
            }

            function onReceiveText(data){
              var textarea = document.getElementById('receive-text');
              var text = data["text"]
              textarea.innerText = text;
            }
            
            /**** these are for add listeners ****/
            var textarea = document.getElementById('send-text');
            textarea.addEventListener('keydown', function(event) {
              if (event.target === textarea) { 
                if (event.keyCode === 13) {
                  event.preventDefault();
                  sendText()
                }
              }
            });

            function chat_history(){
              
            }

            var bt = document.getElementById('dft_join');
            bt.addEventListener("click", join);
            var bt2 = document.getElementById('send-button');
            bt2.addEventListener("click", sendText);

            bt = document.getElmentById('chat-histroy');
            bt.addEventListener("click", chat_history);
            
            //join the room immediately
            join()

        </script>
    </body>
</html>